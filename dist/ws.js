var e=Object.defineProperty,t=(t,n,s)=>((t,n,s)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s)(t,"symbol"!=typeof n?n+"":n,s),n={},s=!1;var r=function(){if(s)return n;s=!0;var e,t="object"==typeof Reflect?Reflect:null,r=t&&"function"==typeof t.apply?t.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}(n=o).once=function(e,t){return new Promise(function(n,s){function r(n){e.removeListener(t,i),s(n)}function i(){"function"==typeof e.removeListener&&e.removeListener("error",r),n([].slice.call(arguments))}m(e,t,i,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&m(e,"error",t,n)}(e,r,{once:!0})})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var a=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,s){var r,i,o;if(l(n),void 0===(i=e._events)?(i=e._events=Object.create(null),e._eventsCount=0):(void 0!==i.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),i=e._events),o=i[t]),void 0===o)o=i[t]=n,++e._eventsCount;else if("function"==typeof o?o=i[t]=s?[n,o]:[o,n]:s?o.unshift(n):o.push(n),(r=h(e))>0&&o.length>r&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=e,a.type=t,a.count=o.length,function(e){console&&console.warn&&console.warn(e)}(a)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function v(e,t,n){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=u.bind(s);return r.listener=n,s.wrapFn=r,r}function f(e,t,n){var s=e._events;if(void 0===s)return[];var r=s[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):d(r,r.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function d(e,t){for(var n=new Array(t),s=0;s<t;++s)n[s]=e[s];return n}function m(e,t,n,s){if("function"==typeof e.on)s.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function r(i){s.once&&e.removeEventListener(t,r),n(i)})}}return Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");a=e}}),o.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return h(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var s="error"===e,i=this._events;if(void 0!==i)s=s&&void 0===i.error;else if(!s)return!1;if(s){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var l=i[e];if(void 0===l)return!1;if("function"==typeof l)r(l,this,t);else{var h=l.length,c=d(l,h);for(n=0;n<h;++n)r(c[n],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return l(t),this.on(e,v(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,v(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,s,r,i,o;if(l(t),void 0===(s=this._events))return this;if(void 0===(n=s[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,i=n.length-1;i>=0;i--)if(n[i]===t||n[i].listener===t){o=n[i].listener,r=i;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(s[e]=n[0]),void 0!==s.removeListener&&this.emit("removeListener",e,o||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,s;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,i=Object.keys(n);for(s=0;s<i.length;++s)"removeListener"!==(r=i[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},o.prototype.listeners=function(e){return f(this,e,!0)},o.prototype.rawListeners=function(e){return f(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},n}();r.once,r.once=function(e,t){return new Promise((n,s)=>{function r(...t){void 0!==i&&e.removeListener("error",i),n(t)}let i;"error"!==t&&(i=t=>{e.removeListener(name,r),s(t)},e.once("error",i)),e.once(t,r)})},r.on=function(e,t){let n=[],s=[],r=null,i=!1,o={async next(){let e=n.shift();if(e)return createIterResult(e,!1);if(r){let e=Promise.reject(r);return r=null,e}return i?createIterResult(void 0,!0):new Promise((e,t)=>s.push({resolve:e,reject:t}))},async return(){e.removeListener(t,a),e.removeListener("error",l),i=!0;for(let e of s)e.resolve(createIterResult(void 0,!0));return createIterResult(void 0,!0)},throw(n){r=n,e.removeListener(t,a),e.removeListener("error",l)},[Symbol.asyncIterator](){return this}};return e.on(t,a),e.on("error",l),o;function a(...e){let t=s.shift();t?t.resolve(createIterResult(e,!1)):n.push(e)}function l(e){i=!0;let t=s.shift();t?t.reject(e):r=e,o.return()}};var{EventEmitter:i,defaultMaxListeners:o,init:a,listenerCount:l,on:h,once:c}=r,u=typeof CloseEvent<"u"?CloseEvent:class extends Event{constructor(e,t){super(e),this.code=t?.code??1e3,this.reason=t?.reason??"",this.wasClean=t?.wasClean??!0}},v=typeof MessageEvent<"u"?MessageEvent:class extends Event{constructor(e,t){super(e),this.data=t?.data}},f=null;try{f=new BroadcastChannel("vite-ws-channel")}catch{}var p=new Map,d=0,m=class e extends i{constructor(n,s){super(),t(this,"CONNECTING",e.CONNECTING),t(this,"OPEN",e.OPEN),t(this,"CLOSING",e.CLOSING),t(this,"CLOSED",e.CLOSED),t(this,"readyState",e.CONNECTING),t(this,"protocol",""),t(this,"extensions",""),t(this,"bufferedAmount",0),t(this,"binaryType","blob"),t(this,"_server",null),t(this,"_nativeWs",null),t(this,"onopen",null),t(this,"onclose",null),t(this,"onerror",null),t(this,"onmessage",null),this.url=n,this._id="client-"+ ++d,s&&(this.protocol=Array.isArray(s)?s[0]:s),setTimeout(()=>this._connect(),0)}_connect(){if(this.url.startsWith("internal://"))return this.readyState=e.OPEN,this.emit("open"),void(this.onopen&&this.onopen(new Event("open")));if(this.url.startsWith("ws://")||this.url.startsWith("wss://"))return void this._connectNative();if(!f)return void setTimeout(()=>{this.readyState=e.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},0);f.postMessage({type:"connect",clientId:this._id,url:this.url});let t=f,n=s=>{let r=s.data;if(r.targetClient===this._id)switch(r.type){case"connected":this.readyState=e.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"));break;case"message":let s=new v("message",{data:r.payload});this.emit("message",s),this.onmessage&&this.onmessage(s);break;case"close":this.readyState=e.CLOSED;let i=new u("close",{code:r.code||1e3,reason:r.reason||"",wasClean:!0});this.emit("close",i),this.onclose&&this.onclose(i),t.removeEventListener("message",n);break;case"error":let o=new Event("error");this.emit("error",o),this.onerror&&this.onerror(o)}};t.addEventListener("message",n),setTimeout(()=>{this.readyState===e.CONNECTING&&(this.readyState=e.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open")))},100)}_connectNative(){let t=typeof window<"u"&&typeof window.document<"u"&&"function"==typeof globalThis.WebSocket&&globalThis.WebSocket!==e?globalThis.WebSocket:null;if(t){try{this._nativeWs=new t(this.url),this._nativeWs.binaryType="arraybuffer"===this.binaryType?"arraybuffer":"blob"}catch{this.readyState=e.CLOSED;let t=new Event("error");return this.emit("error",t),void(this.onerror&&this.onerror(t))}this._nativeWs.onopen=()=>{this.readyState=e.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},this._nativeWs.onmessage=e=>{let t=new v("message",{data:e.data});this.emit("message",t),this.onmessage&&this.onmessage(t)},this._nativeWs.onclose=t=>{this.readyState=e.CLOSED,this._nativeWs=null;let n=new u("close",{code:t.code,reason:t.reason,wasClean:t.wasClean});this.emit("close",n),this.onclose&&this.onclose(n)},this._nativeWs.onerror=()=>{let e=new Event("error");this.emit("error",e),this.onerror&&this.onerror(e)}}else setTimeout(()=>{this.readyState=e.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},0)}send(t){if(this.readyState!==e.OPEN)throw new Error("WebSocket is not open");this._nativeWs?this._nativeWs.send(t):this._server?this._server._handleClientMessage(this,t):f&&f.postMessage({type:"message",clientId:this._id,url:this.url,payload:t})}close(t,n){if(this.readyState!==e.CLOSED&&this.readyState!==e.CLOSING){if(this.readyState=e.CLOSING,this._nativeWs)return void this._nativeWs.close(t,n);f&&f.postMessage({type:"disconnect",clientId:this._id,url:this.url,code:t,reason:n}),setTimeout(()=>{this.readyState=e.CLOSED;let s=new u("close",{code:t||1e3,reason:n||"",wasClean:!0});this.emit("close",s),this.onclose&&this.onclose(s)},0)}}ping(){}pong(){}terminate(){this._nativeWs&&(this._nativeWs.close(),this._nativeWs=null),this.readyState=e.CLOSED;let t=new u("close",{code:1006,reason:"Connection terminated",wasClean:!1});this.emit("close",t),this.onclose&&this.onclose(t)}_setServer(e){this._server=e}_receiveMessage(e){let t=new v("message",{data:e});this.emit("message",t),this.onmessage&&this.onmessage(t)}};t(m,"CONNECTING",0),t(m,"OPEN",1),t(m,"CLOSING",2),t(m,"CLOSED",3);var y=m,g=class extends i{constructor(e={}){super(),t(this,"clients",new Set),t(this,"_channelHandler",null),this.options=e,this._path=e.path||"/",e.noServer||this._setupListener(),p.set(this._path,this)}_setupListener(){if(!f)return;let e=f;this._channelHandler=t=>{let n=t.data;if("connect"===n.type){let t=new y("internal://"+this._path);t._setServer(this),t._clientId=n.clientId,this.clients.add(t),e.postMessage({type:"connected",targetClient:n.clientId}),this.emit("connection",t,{url:n.url})}if("message"===n.type)for(let e of this.clients)if(e._clientId===n.clientId){e._receiveMessage(n.payload);break}if("disconnect"===n.type)for(let e of this.clients)if(e._clientId===n.clientId){e.close(n.code,n.reason),this.clients.delete(e);break}},e.addEventListener("message",this._channelHandler)}_handleClientMessage(e,t){let n=new v("message",{data:t});e.emit("message",n)}handleUpgrade(e,t,n,s){let r=new y("internal://"+this._path);r._setServer(this),!1!==this.options.clientTracking&&this.clients.add(r),setTimeout(()=>{s(r,e),this.emit("connection",r,e)},0)}close(e){for(let e of this.clients)e.close(1001,"Server shutting down");this.clients.clear(),p.delete(this._path),this._channelHandler&&f&&(f.removeEventListener("message",this._channelHandler),this._channelHandler=null),this.emit("close"),e&&setTimeout(e,0)}address(){return{port:this.options.port||0,family:"IPv4",address:this.options.host||"0.0.0.0"}}},_=y,w=g,L=()=>{throw new Error("createWebSocketStream is not supported in browser")};export{w as Server,y as WebSocket,g as WebSocketServer,L as createWebSocketStream,_ as default};
/*! For license information please see ws.js.LEGAL.txt */