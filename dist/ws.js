var B=Object.defineProperty;var U=(h,v,r)=>v in h?B(h,v,{enumerable:!0,configurable:!0,writable:!0,value:r}):h[v]=r;var d=(h,v,r)=>U(h,typeof v!="symbol"?v+"":v,r);var b={},A=!1;function $(){if(A)return b;A=!0;var h=typeof Reflect=="object"?Reflect:null,v=h&&typeof h.apply=="function"?h.apply:function(e,n,i){return Function.prototype.apply.call(e,n,i)},r;h&&typeof h.ownKeys=="function"?r=h.ownKeys:Object.getOwnPropertySymbols?r=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:r=function(e){return Object.getOwnPropertyNames(e)};function l(t){console&&console.warn&&console.warn(t)}var o=Number.isNaN||function(e){return e!==e};function s(){s.init.call(this)}b=s,b.once=k,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var p=10;function E(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return p},set:function(t){if(typeof t!="number"||t<0||o(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");p=t}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function w(t){return t._maxListeners===void 0?s.defaultMaxListeners:t._maxListeners}s.prototype.getMaxListeners=function(){return w(this)},s.prototype.emit=function(e){for(var n=[],i=1;i<arguments.length;i++)n.push(arguments[i]);var a=e==="error",f=this._events;if(f!==void 0)a=a&&f.error===void 0;else if(!a)return!1;if(a){var c;if(n.length>0&&(c=n[0]),c instanceof Error)throw c;var L=new Error("Unhandled error."+(c?" ("+c.message+")":""));throw L.context=c,L}var _=f[e];if(_===void 0)return!1;if(typeof _=="function")v(_,this,n);else for(var j=_.length,K=W(_,j),i=0;i<j;++i)v(K[i],this,n);return!0};function m(t,e,n,i){var a,f,c;if(E(n),f=t._events,f===void 0?(f=t._events=Object.create(null),t._eventsCount=0):(f.newListener!==void 0&&(t.emit("newListener",e,n.listener?n.listener:n),f=t._events),c=f[e]),c===void 0)c=f[e]=n,++t._eventsCount;else if(typeof c=="function"?c=f[e]=i?[n,c]:[c,n]:i?c.unshift(n):c.push(n),a=w(t),a>0&&c.length>a&&!c.warned){c.warned=!0;var L=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");L.name="MaxListenersExceededWarning",L.emitter=t,L.type=e,L.count=c.length,l(L)}return t}s.prototype.addListener=function(e,n){return m(this,e,n,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,n){return m(this,e,n,!0)};function g(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function O(t,e,n){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},a=g.bind(i);return a.listener=n,i.wrapFn=a,a}s.prototype.once=function(e,n){return E(n),this.on(e,O(this,e,n)),this},s.prototype.prependOnceListener=function(e,n){return E(n),this.prependListener(e,O(this,e,n)),this},s.prototype.removeListener=function(e,n){var i,a,f,c,L;if(E(n),a=this._events,a===void 0)return this;if(i=a[e],i===void 0)return this;if(i===n||i.listener===n)--this._eventsCount===0?this._events=Object.create(null):(delete a[e],a.removeListener&&this.emit("removeListener",e,i.listener||n));else if(typeof i!="function"){for(f=-1,c=i.length-1;c>=0;c--)if(i[c]===n||i[c].listener===n){L=i[c].listener,f=c;break}if(f<0)return this;f===0?i.shift():D(i,f),i.length===1&&(a[e]=i[0]),a.removeListener!==void 0&&this.emit("removeListener",e,L||n)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var n,i,a;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[e]),this;if(arguments.length===0){var f=Object.keys(i),c;for(a=0;a<f.length;++a)c=f[a],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(n=i[e],typeof n=="function")this.removeListener(e,n);else if(n!==void 0)for(a=n.length-1;a>=0;a--)this.removeListener(e,n[a]);return this};function T(t,e,n){var i=t._events;if(i===void 0)return[];var a=i[e];return a===void 0?[]:typeof a=="function"?n?[a.listener||a]:[a]:n?H(a):W(a,a.length)}s.prototype.listeners=function(e){return T(this,e,!0)},s.prototype.rawListeners=function(e){return T(this,e,!1)},s.listenerCount=function(t,e){return typeof t.listenerCount=="function"?t.listenerCount(e):M.call(t,e)},s.prototype.listenerCount=M;function M(t){var e=this._events;if(e!==void 0){var n=e[t];if(typeof n=="function")return 1;if(n!==void 0)return n.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]};function W(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}function D(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}function H(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}function k(t,e){return new Promise(function(n,i){function a(c){t.removeListener(e,f),i(c)}function f(){typeof t.removeListener=="function"&&t.removeListener("error",a),n([].slice.call(arguments))}R(t,e,f,{once:!0}),e!=="error"&&F(t,a,{once:!0})})}function F(t,e,n){typeof t.on=="function"&&R(t,"error",e,n)}function R(t,e,n,i){if(typeof t.on=="function")i.once?t.once(e,n):t.on(e,n);else if(typeof t.addEventListener=="function")t.addEventListener(e,function a(f){i.once&&t.removeEventListener(e,a),n(f)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}return b}var N=$();N.once;N.once=function(h,v){return new Promise((r,l)=>{function o(...p){s!==void 0&&h.removeListener("error",s),r(p)}let s;v!=="error"&&(s=p=>{h.removeListener(name,o),l(p)},h.once("error",s)),h.once(v,o)})};N.on=function(h,v){let r=[],l=[],o=null,s=!1,p={async next(){let m=r.shift();if(m)return createIterResult(m,!1);if(o){let g=Promise.reject(o);return o=null,g}return s?createIterResult(void 0,!0):new Promise((g,O)=>l.push({resolve:g,reject:O}))},async return(){h.removeListener(v,E),h.removeListener("error",w),s=!0;for(let m of l)m.resolve(createIterResult(void 0,!0));return createIterResult(void 0,!0)},throw(m){o=m,h.removeListener(v,E),h.removeListener("error",w)},[Symbol.asyncIterator](){return this}};return h.on(v,E),h.on("error",w),p;function E(...m){let g=l.shift();g?g.resolve(createIterResult(m,!1)):r.push(m)}function w(m){s=!0;let g=l.shift();g?g.reject(m):o=m,p.return()}};var{EventEmitter:I,defaultMaxListeners:J,init:Q,listenerCount:X,on:Y,once:Z}=N;var S=typeof CloseEvent<"u"?CloseEvent:class extends Event{constructor(v,r){super(v),this.code=r?.code??1e3,this.reason=r?.reason??"",this.wasClean=r?.wasClean??!0}},x=typeof MessageEvent<"u"?MessageEvent:class extends Event{constructor(v,r){super(v),this.data=r?.data}},y=null;try{y=new BroadcastChannel("vite-ws-channel")}catch{}var G=new Map,V=0,u=class u extends I{constructor(r,l){super();d(this,"CONNECTING",u.CONNECTING);d(this,"OPEN",u.OPEN);d(this,"CLOSING",u.CLOSING);d(this,"CLOSED",u.CLOSED);d(this,"readyState",u.CONNECTING);d(this,"protocol","");d(this,"extensions","");d(this,"bufferedAmount",0);d(this,"binaryType","blob");d(this,"_server",null);d(this,"_nativeWs",null);d(this,"onopen",null);d(this,"onclose",null);d(this,"onerror",null);d(this,"onmessage",null);this.url=r,this._id=`client-${++V}`,l&&(this.protocol=Array.isArray(l)?l[0]:l),setTimeout(()=>this._connect(),0)}_connect(){if(this.url.startsWith("internal://")){this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"));return}if(this.url.startsWith("ws://")||this.url.startsWith("wss://")){this._connectNative();return}if(!y){setTimeout(()=>{this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},0);return}y.postMessage({type:"connect",clientId:this._id,url:this.url});let r=y,l=o=>{let s=o.data;if(s.targetClient===this._id)switch(s.type){case"connected":this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"));break;case"message":let p=new x("message",{data:s.payload});this.emit("message",p),this.onmessage&&this.onmessage(p);break;case"close":this.readyState=u.CLOSED;let E=new S("close",{code:s.code||1e3,reason:s.reason||"",wasClean:!0});this.emit("close",E),this.onclose&&this.onclose(E),r.removeEventListener("message",l);break;case"error":let w=new Event("error");this.emit("error",w),this.onerror&&this.onerror(w);break}};r.addEventListener("message",l),setTimeout(()=>{this.readyState===u.CONNECTING&&(this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open")))},100)}_connectNative(){let l=typeof window<"u"&&typeof window.document<"u"&&typeof globalThis.WebSocket=="function"&&globalThis.WebSocket!==u?globalThis.WebSocket:null;if(!l){setTimeout(()=>{this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},0);return}try{this._nativeWs=new l(this.url),this._nativeWs.binaryType=this.binaryType==="arraybuffer"?"arraybuffer":"blob"}catch{this.readyState=u.CLOSED;let o=new Event("error");this.emit("error",o),this.onerror&&this.onerror(o);return}this._nativeWs.onopen=()=>{this.readyState=u.OPEN,this.emit("open"),this.onopen&&this.onopen(new Event("open"))},this._nativeWs.onmessage=o=>{let s=new x("message",{data:o.data});this.emit("message",s),this.onmessage&&this.onmessage(s)},this._nativeWs.onclose=o=>{this.readyState=u.CLOSED,this._nativeWs=null;let s=new S("close",{code:o.code,reason:o.reason,wasClean:o.wasClean});this.emit("close",s),this.onclose&&this.onclose(s)},this._nativeWs.onerror=()=>{let o=new Event("error");this.emit("error",o),this.onerror&&this.onerror(o)}}send(r){if(this.readyState!==u.OPEN)throw new Error("WebSocket is not open");if(this._nativeWs){this._nativeWs.send(r);return}if(this._server){this._server._handleClientMessage(this,r);return}y&&y.postMessage({type:"message",clientId:this._id,url:this.url,payload:r})}close(r,l){if(!(this.readyState===u.CLOSED||this.readyState===u.CLOSING)){if(this.readyState=u.CLOSING,this._nativeWs){this._nativeWs.close(r,l);return}y&&y.postMessage({type:"disconnect",clientId:this._id,url:this.url,code:r,reason:l}),setTimeout(()=>{this.readyState=u.CLOSED;let o=new S("close",{code:r||1e3,reason:l||"",wasClean:!0});this.emit("close",o),this.onclose&&this.onclose(o)},0)}}ping(){}pong(){}terminate(){this._nativeWs&&(this._nativeWs.close(),this._nativeWs=null),this.readyState=u.CLOSED;let r=new S("close",{code:1006,reason:"Connection terminated",wasClean:!1});this.emit("close",r),this.onclose&&this.onclose(r)}_setServer(r){this._server=r}_receiveMessage(r){let l=new x("message",{data:r});this.emit("message",l),this.onmessage&&this.onmessage(l)}};d(u,"CONNECTING",0),d(u,"OPEN",1),d(u,"CLOSING",2),d(u,"CLOSED",3);var C=u,P=class extends I{constructor(r={}){super();d(this,"clients",new Set);d(this,"_channelHandler",null);this.options=r,this._path=r.path||"/",r.noServer||this._setupListener(),G.set(this._path,this)}_setupListener(){if(!y)return;let r=y;this._channelHandler=l=>{let o=l.data;if(o.type==="connect"){let s=new C("internal://"+this._path);s._setServer(this),s._clientId=o.clientId,this.clients.add(s),r.postMessage({type:"connected",targetClient:o.clientId}),this.emit("connection",s,{url:o.url})}if(o.type==="message"){for(let s of this.clients)if(s._clientId===o.clientId){s._receiveMessage(o.payload);break}}if(o.type==="disconnect"){for(let s of this.clients)if(s._clientId===o.clientId){s.close(o.code,o.reason),this.clients.delete(s);break}}},r.addEventListener("message",this._channelHandler)}_handleClientMessage(r,l){let o=new x("message",{data:l});r.emit("message",o)}handleUpgrade(r,l,o,s){let p=new C("internal://"+this._path);p._setServer(this),this.options.clientTracking!==!1&&this.clients.add(p),setTimeout(()=>{s(p,r),this.emit("connection",p,r)},0)}close(r){for(let l of this.clients)l.close(1001,"Server shutting down");this.clients.clear(),G.delete(this._path),this._channelHandler&&y&&(y.removeEventListener("message",this._channelHandler),this._channelHandler=null),this.emit("close"),r&&setTimeout(r,0)}address(){return{port:this.options.port||0,family:"IPv4",address:this.options.host||"0.0.0.0"}}},se=C,re=P,ie=()=>{throw new Error("createWebSocketStream is not supported in browser")};export{re as Server,C as WebSocket,P as WebSocketServer,ie as createWebSocketStream,se as default};
/*! For license information please see ws.js.LEGAL.txt */
